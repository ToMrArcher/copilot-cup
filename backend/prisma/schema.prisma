// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// User & Authentication
// ==========================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  role         Role     @default(VIEWER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dashboards      Dashboard[]
  ownedKpis       Kpi[]             @relation("KpiOwner")
  shareLinks      ShareLink[]
  dashboardAccess DashboardAccess[]
  kpiAccess       KpiAccess[]
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum AccessPermission {
  VIEW
  EDIT
}

// ==========================================
// Integrations (Data Sources)
// ==========================================

model Integration {
  id           String          @id @default(cuid())
  name         String
  type         IntegrationType
  config       Json            // Encrypted configuration
  status       String          @default("pending")
  lastSync     DateTime?
  
  // Scheduled sync settings
  syncInterval Int?            @default(3600)  // seconds between syncs, null = manual only
  syncEnabled  Boolean         @default(true)  // whether scheduled sync is enabled
  nextSyncAt   DateTime?                       // when the next sync should occur
  retryCount   Int             @default(0)     // consecutive failure count
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  dataFields   DataField[]
  kpis         Kpi[]
  syncLogs     SyncLog[]
}

// Sync history log
model SyncLog {
  id            String      @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  status        SyncStatus
  startedAt     DateTime    @default(now())
  completedAt   DateTime?
  duration      Int?        // milliseconds
  recordsCount  Int?        // number of data values synced
  errorMessage  String?     @db.Text
  
  createdAt     DateTime    @default(now())
  
  @@index([integrationId, createdAt(sort: Desc)])
}

enum SyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum IntegrationType {
  API
  MANUAL
  WEBHOOK
  GRAPHQL
}

model DataField {
  id            String      @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  name          String
  path          String      // JSON path or field reference
  dataType      String      // string, number, date, etc.
  createdAt     DateTime    @default(now())

  kpiSources KpiSource[]
  values     DataValue[]
}

// Stores synced values from integrations
model DataValue {
  id          String    @id @default(cuid())
  dataFieldId String
  dataField   DataField @relation(fields: [dataFieldId], references: [id], onDelete: Cascade)
  value       Json      // Actual value (supports any type)
  syncedAt    DateTime  @default(now())

  @@index([dataFieldId, syncedAt])
}

// ==========================================
// KPIs
// ==========================================

model Kpi {
  id              String      @id @default(cuid())
  name            String
  description     String?
  formula         String      // Formula expression
  integrationId   String?
  integration     Integration? @relation(fields: [integrationId], references: [id])
  ownerId         String?
  owner           User?       @relation("KpiOwner", fields: [ownerId], references: [id])
  currentValue    Float?
  targetValue     Float?
  targetDirection String?     // increase, decrease
  targetPeriod    String?     // daily, weekly, monthly, quarterly, yearly
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  sources    KpiSource[]
  widgets    Widget[]
  shareLinks ShareLink[]
  accessList KpiAccess[]
}

model KpiSource {
  id          String    @id @default(cuid())
  kpiId       String
  kpi         Kpi       @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  dataFieldId String
  dataField   DataField @relation(fields: [dataFieldId], references: [id], onDelete: Cascade)
  alias       String?   // Variable name in formula
  createdAt   DateTime  @default(now())
}

// ==========================================
// Dashboards & Widgets
// ==========================================

model Dashboard {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id])
  layout    Json?    // Grid layout configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  widgets    Widget[]
  shareLinks ShareLink[]
  accessList DashboardAccess[]
}

model Widget {
  id          String    @id @default(cuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  kpiId       String?
  kpi         Kpi?      @relation(fields: [kpiId], references: [id])
  type        String    // chart, number, gauge, etc.
  config      Json?     // Widget-specific configuration
  position    Json      // { x, y, w, h }
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ==========================================
// Sharing
// ==========================================

model ShareLink {
  id             String     @id @default(cuid())
  token          String     @unique
  name           String?    // Optional friendly name
  resourceType   String     // dashboard, kpi
  dashboardId    String?
  dashboard      Dashboard? @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  kpiId          String?
  kpi            Kpi?       @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User       @relation(fields: [createdById], references: [id])
  showTarget     Boolean    @default(true)
  expiresAt      DateTime?
  active         Boolean    @default(true)
  accessCount    Int        @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime   @default(now())

  @@index([createdById])
}

// ==========================================
// Access Control
// ==========================================

model DashboardAccess {
  id          String           @id @default(cuid())
  dashboardId String
  dashboard   Dashboard        @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission  AccessPermission @default(VIEW)
  grantedAt   DateTime         @default(now())
  grantedById String?

  @@unique([dashboardId, userId])
  @@index([userId])
}

model KpiAccess {
  id          String           @id @default(cuid())
  kpiId       String
  kpi         Kpi              @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission  AccessPermission @default(VIEW)
  grantedAt   DateTime         @default(now())
  grantedById String?

  @@unique([kpiId, userId])
  @@index([userId])
}
